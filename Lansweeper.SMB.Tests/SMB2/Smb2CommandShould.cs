using Lansweeper.Smb.SMB2;
using Lansweeper.Smb.SMB2.Commands;
using Lansweeper.Smb.SMB2.Enums;

namespace Lansweeper.SMB.Tests.SMB2;

public class Smb2CommandTests
{
    [Test]
    public void ReadRequestCorrectly()
    {
        byte[] securityBlob = [
          0x60, 0x48, 0x06, 0x06, 0x2b, 0x06, 0x01, 0x05,
          0x05, 0x02, 0xa0, 0x3e, 0x30, 0x3c, 0xa0, 0x0e,
          0x30, 0x0c, 0x06, 0x0a, 0x2b, 0x06, 0x01, 0x04,
          0x01, 0x82, 0x37, 0x02, 0x02, 0x0a, 0xa2, 0x2a,
          0x04, 0x28, 0x4e, 0x54, 0x4c, 0x4d, 0x53, 0x53,
          0x50, 0x00, 0x01, 0x00, 0x00, 0x00, 0x97, 0x82,
          0x08, 0xe2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x0a, 0x00, 0x5a, 0x29, 0x00, 0x00,
          0x00, 0x0f
        ];

        byte[] buffer = [
          0xfe, 0x53, 0x4d, 0x42, 0x40, 0x00, 0x01, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x1f, 0x00,
          0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          0x19, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x58, 0x00, 0x4a, 0x00,
          0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
          ..securityBlob,
        ];

        ReadOnlySpan<byte> input = buffer;
        var request = Smb2Command.ReadRequest(ref input, Smb2Dialect.SMB311);

        var sessionSetupRequest = request.Should().BeOfType<SessionSetupRequest>().Which;
        sessionSetupRequest.Header.CreditCharge.Should().Be(1);
        sessionSetupRequest.Header.Credits.Should().Be(31);
        sessionSetupRequest.Header.IsResponse.Should().BeFalse();
        sessionSetupRequest.Header.IsAsync.Should().BeFalse();
        sessionSetupRequest.Header.IsRelatedOperations.Should().BeFalse();
        sessionSetupRequest.Header.IsSigned.Should().BeFalse();
        sessionSetupRequest.Header.Priority.Should().Be(1);
        sessionSetupRequest.Header.Command.Should().Be(Smb2CommandName.SessionSetup);
        sessionSetupRequest.Header.MessageID.Should().Be(2);
        sessionSetupRequest.Header.Reserved.Should().Be(0xfeff);
        sessionSetupRequest.Flags.Should().Be(SessionSetupFlags.None);
        sessionSetupRequest.SecurityMode.Should().Be(SecurityMode.SigningEnabled);
        sessionSetupRequest.Capabilities.Should().Be(Capabilities.DFS);
        sessionSetupRequest.Channel.Should().Be(0);
        sessionSetupRequest.PreviousSessionId.Should().Be(0);
        sessionSetupRequest.SecurityBuffer.Should().Equal(securityBlob);
    }

    [Test]
    public void ReadResponseCorrectly()
    {
        byte[] buffer = [
            0xFE,0x53,0x4D,0x42,0x40,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,
            0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00
        ];

        ReadOnlySpan<byte> input = buffer;
        var response = Smb2Command.ReadResponse(ref input, Smb2Dialect.SMB311);

        var sessionSetupResponse = response.Should().BeOfType<LogoffResponse>().Which;
        sessionSetupResponse.Header.Command.Should().Be(Smb2CommandName.Logoff);
        sessionSetupResponse.Header.IsResponse.Should().BeTrue();
        sessionSetupResponse.Reserved.Should().Be(0);

    }


}
